* Undo-tree

Global location to save undo-tree history files rather than littering the file
system with .~undo-tree~ files.

#+BEGIN_SRC emacs-lisp
(defcustom user-emacs-auto-undotree
  (concat user-emacs-auto-directory "undotree/")
  "Directory for auto-generated undo-tree history files."
  :group 'user-emacs-auto
  :type 'directory)
#+END_SRC

- Replace standard Emacs undo system with the undo-tree system
- Display diff by default
- Exit undo-tree-visualiser when the RETURN key is pressed


#+BEGIN_SRC emacs-lisp
(use-package undo-tree
  :defer t
  :diminish undo-tree-mode
  :bind (:map undo-tree-map ("C-x u" . undo-tree-visualize))

  ;; Execute code before package is loaded.
  :init
  (progn
    (global-undo-tree-mode t)

  ;;   (defhydra hydra-undo-tree (:color blue :hint nil)
  ;;     "
  ;;     ^Undo Tree^         ^Navigation^
  ;;     -------------------------------------
  ;;     _p_: Previous       _h_: Left
  ;;     _n_: Next           _j_: Down
  ;;     _f_: Parent         _k_: Up
  ;;     _u_: Undo           _l_: Right
  ;;     _r_: Redo           _q_: Quit
  ;;     "
  ;;     ("p" undo-tree-visualize-undo)
  ;;     ("u" undo-tree-visualize-undo)
  ;;     ("n" undo-tree-visualize-redo)
  ;;     ("r" undo-tree-visualize-redo)
  ;;     ("f" undo-tree-visualize-switch-branch-right)
  ;;     ("h" undo-tree-visualize-left)
  ;;     ("j" undo-tree-visualize-down)
  ;;     ("k" undo-tree-visualize-up)
  ;;     ("l" undo-tree-visualize-right)
  ;;     ("q" undo-tree-visualizer-quit :color blue)
  ;;   )
  )

  ;; Execute code after package is loaded.
  :config
  (progn

    ;; Explicitly ask Emacs to save undo-tree history files (default
    ;; behaviour since ~0.8.2).
    (if (and (<= emacs-major-version 24) (< emacs-minor-version 3))
        (setq undo-tree-auto-save-history t)
        (customize-set-variable 'undo-tree-auto-save-history t)
    )

    ;; Save undo-tree history files to global location.
    (setq undo-tree-history-directory-alist `(("." . ,user-emacs-auto-undotree)))

    ;; Since the undo-tree history files are in a global location, the
    ;; '.~undo-tree~' suffix is not required. Use an advising function to
    ;; remove the suffix from 'undo-tree-make-history-save-file-name'. Add '#'
    ;; to the beginning and end of the basename (like auto-save) in case the
    ;; global directory fails.
    (defun remove-undo-tree-suffix (orig-func &rest args)
      (message "args %S" args)
      (let* ((filename (apply orig-func args))
             (dirname  (file-name-directory filename))
             (basename (file-name-nondirectory filename)))
        (setq basename (replace-regexp-in-string "\\.~undo-tree~$" "" basename))
        (setq basename (concat "#" basename "#"))
        (setq filename (concat dirname basename))
        filename)
    )
    (advice-add 'undo-tree-make-history-save-file-name :around #'remove-undo-tree-suffix)


    ;; Exit undo-tree when the RETURN key is pressed.
    (define-key undo-tree-visualizer-mode-map (kbd "RET") 'undo-tree-visualizer-quit)

    ;;(define-key undo-tree-map (kbd "C-x u") 'undo-tree-visualize)

    ;; (defadvice undo-tree-draw-tree (after hydra-undo-tree activate)
    ;;   (hydra-undo-tree/body))

    ;; (advice-add 'undo-tree-visualize-undo :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualize-redo :before 'hydra-undo-tree/body)

    ;; (advice-add 'undo-tree-visualize-undo-to-x :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualize-redo-to-x :before 'hydra-undo-tree/body)

    ;; (advice-add 'undo-tree-visualize-switch-branch-left :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualize-switch-branch-right :before 'hydra-undo-tree/body)

    ;; (advice-add 'undo-tree-visualizer-scroll-up :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualizer-scroll-down :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualizer-scroll-left :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualizer-scroll-right :before 'hydra-undo-tree/body)

    ;; (advice-add 'undo-tree-visualizer-toggle-diff :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualizer-toggle-timestamps :before 'hydra-undo-tree/body)
    ;; (advice-add 'undo-tree-visualizer-mouse-set :after 'hydra-undo-tree/body)
  )
)
#+END_SRC
